<?php
class db_ext_atm_ora_Account extends oracleConnect {


	/**
	* __GetCustAccount()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 23:43:46 PDT 2007
	*/
	protected function __GetCustAccount($cust_account_id)
	{
	   $q = "SELECT CUST_ACCOUNT_ID, OBJECT_VERSION_NUMBER FROM HZ_CUST_ACCOUNTS WHERE CUST_ACCOUNT_ID='".$cust_account_id."'";
		$this->parse($q);
		$this->execute(OCI_DEFAULT);
		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
		} else {
			return array("error_code"=>-1, "error_message"=>"__GetCustAccount($cust_account_id) didn't retrieve any result !");
		}
	}

	/**
	* __GetCustAccountParty()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:17:34 PDT 2007
	*/
	protected function __GetCustAccountParty($cust_account_id)
	{
		$q = "SELECT P.PARTY_ID, P.OBJECT_VERSION_NUMBER FROM HZ_CUST_ACCOUNTS A LEFT JOIN HZ_PARTIES P ON P.PARTY_ID=A.PARTY_ID WHERE A.CUST_ACCOUNT_ID='$cust_account_id'";
		$this->parse($q);
		$this->execute(OCI_DEFAULT);
		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
		} else {
			return array("error_code"=>-1, "error_message"=>"__GetCustAccountParty($cust_account_id) didn't retrieve any result !");
		}
	}

	/**
	* __GetCustAccountProfile()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:19:50 PDT 2007
	*/
	protected function __GetCustAccountProfile($cust_account_id)
	{
		$q = "SELECT cp.cust_account_profile_id, cp.object_version_number FROM HZ_CUST_ACCOUNTS a LEFT JOIN HZ_CUSTOMER_PROFILES cp ON cp.cust_account_id=a.cust_account_id AND cp.site_use_id IS NULL WHERE a.cust_account_id='".$cust_account_id."'";
		$this->parse($q);
		$this->execute(OCI_DEFAULT);
		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
		} else {
			return array("error_code"=>-1, "error_message"=>"__GetCustAccountProfile($cust_account_id) didn't retrieve any result !");
		}
	}

	/**
	* CreateCustAccount()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:15:37 PDT 2007
	*/
	public function CreateCustAccount($company_name, $tax_id,  $tax_reference_number, $payment_term) {

		$plsql = "DECLARE ";
		$plsql .= " p_cust_account_rec HZ_CUST_ACCOUNT_V2PUB.CUST_ACCOUNT_REC_TYPE;";
		$plsql .= " p_organization_rec HZ_PARTY_V2PUB.ORGANIZATION_REC_TYPE;";
		$plsql .= " p_customer_profile_rec HZ_CUSTOMER_PROFILE_V2PUB.CUSTOMER_PROFILE_REC_TYPE;";
		$plsql .= " x_account_number VARCHAR2(2000);";
		$plsql .= " x_party_number VARCHAR2(2000);";
		$plsql .= " x_profile_id NUMBER;";
		$plsql .= "BEGIN ";
		$plsql .= " p_cust_account_rec.account_number := '';";
		$plsql .= " p_cust_account_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " p_organization_rec.organization_name := '".strtoupper($company_name)."';";
		$plsql .= " p_organization_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " p_organization_rec.tax_reference := '$tax_reference_number';";
		$plsql .= " p_organization_rec.jgzz_fiscal_code := '$tax_id';";
		$plsql .= " p_customer_profile_rec.standard_terms := $payment_term;";
		$plsql .= " p_customer_profile_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " hz_cust_account_v2pub.create_cust_account('T', p_cust_account_rec, p_organization_rec, p_customer_profile_rec, 'F', :x_cust_account_id, x_account_number, :x_party_id, x_party_number, x_profile_id, :x_return_status, :x_msg_count, :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['x_cust_account_id'] = 0;
		$len['x_cust_account_id'] = 11;
		$var['x_party_id'] = 0;
		$len['x_party_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			$this->rollback();
			return array("error_code"=>-1, "error_message"=>"CreateCustAccount($company_name, $tax_id, $tax_reference_number, $payment_term) failed with error message : ".$var["x_msg_data"]);
		}

		$this->commit();
		return array("error_code"=>0, "error_message"=>"CreateCustAccount($company_name, $tax_id, $tax_reference_number, $payment_term) successful !", "data"=>array("cust_account_id"=>$var["x_cust_account_id"]));
	}

	/**
	* __UpdateCustAccount()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 23:33:52 PDT 2007
	*/
	protected function __UpdateCustAccount($cust_account_id, $object_version_number=1)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_cust_account_rec HZ_CUST_ACCOUNT_V2PUB.CUST_ACCOUNT_REC_TYPE;";
		$plsql .= "BEGIN ";
		$plsql .= " p_cust_account_rec.cust_account_id := '".$cust_account_id."';";
		$plsql .= " p_cust_account_rec.status := 'A';";
		$plsql .= " hz_cust_account_v2pub.update_cust_account('T', p_cust_account_rec, :ver, :x_return_status, :x_msg_count, :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['ver'] = $object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdateCustAccount($cust_account_id, $object_version_number) failed with error message : ".$var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__UpdateCustAccount($cust_account_id, $object_version_number) successful !", "data"=>array());
	}

	/**
	* __UpdateOrganization()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:25:55 PDT 2007
	*/
	protected function __UpdateOrganization($party_id, $company_name, $tax_id, $tax_reference_number, $party_object_version_number=1)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_organization_rec HZ_PARTY_V2PUB.ORGANIZATION_REC_TYPE;";
		$plsql .= " x_profile_id NUMBER;";
		$plsql .= "BEGIN ";
		$plsql .= " p_organization_rec.party_rec.party_id := '" . $party_id . "';";
		$plsql .= " p_organization_rec.party_rec.status := 'A';";
		$plsql .= " p_organization_rec.organization_name := '" . strtoupper($company_name) . "';";
		$plsql .= " p_organization_rec.tax_reference := '" . $tax_reference_number . "';";
		$plsql .= " p_organization_rec.jgzz_fiscal_code := '" . $tax_id . "';";
		$plsql .= " hz_party_v2pub.update_organization('T', p_organization_rec, :ver, :x_profile_id, :x_return_status, :x_msg_count, :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['ver'] = $party_object_version_number;
		$len['ver'] = 11;
		$var['x_profile_id'] = 0;
		$len['x_profile_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdateOrganization($party_id, $company_name, $tax_id, $tax_reference_number, $party_object_version_number) failed with error message ".$var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__UpdateOrganization($party_id, $company_name, $tax_id, $tax_reference_number, $party_object_version_number) successful !", "data"=>array());
	}

	/**
	* __UpdateCustomerProfile()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:32:12 PDT 2007
	*/
	protected function __UpdateCustomerProfile($cust_account_profile_id, $cust_account_id, $payment_term, $cust_account_profile_object_version_number=1)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_customer_profile_rec HZ_CUSTOMER_PROFILE_V2PUB.CUSTOMER_PROFILE_REC_TYPE;";
		$plsql .= "BEGIN ";
		$plsql .= " p_customer_profile_rec.cust_account_profile_id := '" . $cust_account_profile_id . "';";
		$plsql .= " p_customer_profile_rec.cust_account_id := '" . $cust_account_id . "';";
		$plsql .= " p_customer_profile_rec.standard_terms := " . $payment_term . ";";
		$plsql .= " p_customer_profile_rec.status := 'A';";
		$plsql .= " hz_customer_profile_v2pub.update_customer_profile('T', p_customer_profile_rec, :ver, :x_return_status, :x_msg_count, :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['ver'] = $cust_account_profile_object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdateCustomerProfile($cust_account_profile_id, $cust_account_id, $payment_term, $cust_account_profile_object_version_number) failed with error message ".$var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__UpdateCustomerProfile($cust_account_profile_id, $cust_account_id, $payment_term, $cust_account_profile_object_version_number) successful !", "data"=>array());
	}

	/**
	* UpdateCustAccount()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:16:28 PDT 2007
	*/
	public function UpdateCustAccount($cust_account_id, $company_name, $tax_id, $tax_reference_number, $payment_term) {

		$cust_account = $this->__GetCustAccount($cust_account_id);
		if ($cust_account["error_code"]) {
			$this->rollback();
			return $cust_account;
		}

		$party = $this->__GetCustAccountParty($cust_account_id);
		if ($party["error_code"]) {
			$this->rollback();
			return $party;
		}

		$profile = $this->__GetCustAccountProfile($cust_account_id);
		if ($profile["error_code"]) {
			$this->rollback();
			return $profile;
		}

		$account = $this->__UpdateCustAccount($cust_account_id, $cust_account["data"]["OBJECT_VERSION_NUMBER"]);
		if ($account["error_code"]) {
			$this->rollback();
			return $account;
		}


		$organization = $this->__UpdateOrganization($party["data"]["PARTY_ID"], $company_name, $tax_id, $tax_reference_number, $party["data"]["OBJECT_VERSION_NUMBER"]);
		if ($organization["error_code"]) {
			$this->rollback();
			return $organization;
		}

		$profile = $this->__UpdateCustomerProfile($profile["data"]["CUST_ACCOUNT_PROFILE_ID"], $cust_account_id, $payment_term, $profile["data"]["OBJECT_VERSION_NUMBER"]);
		if ($profile["error_code"]) {
			$this->rollback();
			return $profile;
		}

		$this->commit();
		return array("error_code"=>0, "error_message"=>"UpdateCustAccount($cust_account_id, $company_name, $tax_id, $tax_reference_number, $payment_term) successful !", "data"=>array());
	}


	/**
	* GetCustAccount()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:34:15 PDT 2007
	*/
	public function GetCustAccount($cust_account_id)
	{
		$q = "SELECT A.CUST_ACCOUNT_ID, P.PARTY_NAME COMPANY_NAME, P.TAX_REFERENCE TAX_REGISTRATION_NUMBER, P.JGZZ_FISCAL_CODE TAX_ID, CP.STANDARD_TERMS PAYMENT_TERM FROM HZ_CUST_ACCOUNTS A LEFT JOIN HZ_PARTIES P ON P.PARTY_ID=A.PARTY_ID LEFT JOIN HZ_CUSTOMER_PROFILES CP ON CP.CUST_ACCOUNT_ID=A.CUST_ACCOUNT_ID WHERE A.CUST_ACCOUNT_ID='$cust_account_id' AND A.STATUS='A'";
		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_mesage"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"GetCustAccount($cust_account_id) didn't retrieve any results !");
	}

	/**
	* __CreateLocation()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:41:25 PDT 2007
	*/
	protected function __CreateLocation($address1, $address2, $city, $county, $zip, $state, $country)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_location_rec HZ_LOCATION_V2PUB.LOCATION_REC_TYPE;";
		$plsql .= "BEGIN ";
		$plsql .= " p_location_rec.country := '".strtoupper($country)."';";
		$plsql .= " p_location_rec.address1 := '".strtoupper($address1)."';";
		$plsql .= " p_location_rec.address2 := '".strtoupper($address2)."';";
		$plsql .= " p_location_rec.city := '".strtoupper($city)."';";
		$plsql .= " p_location_rec.postal_code := '".strtoupper($zip)."';";
		$plsql .= " p_location_rec.county := '".strtoupper($county)."';";
		$plsql .= " p_location_rec.state := '".strtoupper($state)."';";
		$plsql .= " p_location_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " hz_location_v2pub.create_location(";
		$plsql .= " 'T',";
		$plsql .= " p_location_rec,";
		$plsql .= " :x_location_id,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= " END;";

		$var['x_location_id'] = 0;
		$len['x_location_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateLocation($address1, $address2, $city, $county, $zip, $state, $country) failed with error message " . $var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__CreateLocation($address1, $address2, $city, $county, $zip, $state, $country) successful !", "data"=> array("location_id"=>$var["x_location_id"]));
	}

	/**
	* __UpdateLocation()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:59:33 PDT 2007
	*/
	protected function __UpdateLocation($location_id, $address1, $address2, $city, $county, $zip, $state, $country, $object_version_number=1)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_location_rec HZ_LOCATION_V2PUB.LOCATION_REC_TYPE;";
		$plsql .= "BEGIN ";
		$plsql .= " p_location_rec.location_id := '" . $location_id . "';";
		$plsql .= " p_location_rec.country := '".strtoupper($country)."';";
		$plsql .= " p_location_rec.address1 := '".strtoupper($address1)."';";
		$plsql .= " p_location_rec.address2 := '".strtoupper($address2)."';";
		$plsql .= " p_location_rec.city := '".strtoupper($city)."';";
		$plsql .= " p_location_rec.postal_code := '".strtoupper($zip)."';";
		$plsql .= " p_location_rec.county := '".strtoupper($county)."';";
		$plsql .= " p_location_rec.state := '".strtoupper($state)."';";
		$plsql .= " hz_location_v2pub.update_location('T', p_location_rec, :ver, :x_return_status, :x_msg_count, :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['ver'] = $object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdateLocation($location_id, $address1, $address2, $city, $county, $zip, $state, $country, $object_version_number) failed with error message " . $var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__UpdateLocation($location_id, $address1, $address2, $city, $county, $zip, $state, $country, $object_version_number) successful !", "data"=> array());
	}

	/**
	* __CreatePartySite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:48:20 PDT 2007
	*/
	protected function __CreatePartySite($party_id, $location_id, $primary='N')
	{
		$plsql = "DECLARE ";
		$plsql .= " p_party_site_rec HZ_PARTY_SITE_V2PUB.PARTY_SITE_REC_TYPE;";
		$plsql .= " x_party_site_number VARCHAR2(2000);";
		$plsql .= "BEGIN ";
		$plsql .= " p_party_site_rec.party_id := " . $party_id . ";";
		$plsql .= " p_party_site_rec.location_id := " . $location_id . ";";
		$plsql .= " p_party_site_rec.identifying_address_flag := '" . $primary . "';";
		$plsql .= " p_party_site_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " hz_party_site_v2pub.create_party_site(";
		$plsql .= " 'T',";
		$plsql .= " p_party_site_rec,";
		$plsql .= " :x_party_site_id,";
		$plsql .= " x_party_site_number,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['x_party_site_id'] = 0;
		$len['x_party_site_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreatePartySite($party_id, $location_id, $primary) failed with error message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreatePartySite($party_id, $location_id, $primary) successful !", "data"=>array("party_site_id"=>$var["x_party_site_id"]));
	}

	/**
	* __UpdatePartySite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:43:38 PDT 2007
	*/
	protected function __UpdatePartySite($party_site_id, $location_id, $primary="Y", $object_version_number=1)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_party_site_rec HZ_PARTY_SITE_V2PUB.PARTY_SITE_REC_TYPE;";
		$plsql .= "BEGIN ";
		$plsql .= " p_party_site_rec.party_site_id := " . $party_site_id . ";";
		$plsql .= " p_party_site_rec.location_id := " . $location_id . ";";
		$plsql .= " p_party_site_rec.identifying_address_flag := '" . $primary . "';";
		$plsql .= " p_party_site_rec.status := 'A';";
		$plsql .= " hz_party_site_v2pub.update_party_site(";
		$plsql .= " 'T',";
		$plsql .= " p_party_site_rec,";
		$plsql .= " :ver,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['ver'] = $object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdatePartySite($party_site_id, $location_id, $primary, $object_version_number) failed with error message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__UpdatePartySite($party_site_id, $location_id, $primary, $object_version_number) successful !", "data"=>array());
	}
	/**
	* __CreateCustAcctSite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:51:59 PDT 2007
	*/
	protected function __CreateCustAcctSite($cust_account_id, $party_site_id)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_cust_acct_site_rec HZ_CUST_ACCOUNT_SITE_V2PUB.CUST_ACCT_SITE_REC_TYPE;";
		$plsql .= "BEGIN ";
		$plsql .= " p_cust_acct_site_rec.cust_account_id := " . $cust_account_id . "; ";
		$plsql .= " p_cust_acct_site_rec.party_site_id := " . $party_site_id . ";";
		$plsql .= " p_cust_acct_site_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " hz_cust_account_site_v2pub.create_cust_acct_site(";
		$plsql .= " 'T',";
		$plsql .= " p_cust_acct_site_rec,";
		$plsql .= " :x_cust_acct_site_id,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .="END;";

		$var['x_cust_acct_site_id'] = 12;
		$len['x_cust_acct_site_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateCustAcctSite($cust_account_id, $party_site_id) failed with error message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreateCustAcctSite($cust_account_id, $party_site_id) successful !", "data"=>array("cust_acct_site_id"=>$var["x_cust_acct_site_id"]));
	}

	/**
	* __CreateCustAcctSiteUse()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:58:52 PDT 2007
	*/
	private function __CreateCustAcctSiteUse($cust_acct_site_id, $location, $use, $tax_code="", $primary = "N", $bill_to_site_use_id = 0)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_cust_site_use_rec HZ_CUST_ACCOUNT_SITE_V2PUB.CUST_SITE_USE_REC_TYPE;";
		$plsql .= " p_customer_profile_rec HZ_CUSTOMER_PROFILE_V2PUB.CUSTOMER_PROFILE_REC_TYPE;";
		$plsql .= " BEGIN ";
		$plsql .= " p_cust_site_use_rec.cust_acct_site_id := " . $cust_acct_site_id . ";";
		$plsql .= " p_cust_site_use_rec.location := '" . strtoupper($location) . "';";
		if ($bill_to_site_use_id != 0) {
			$plsql .= " p_cust_site_use_rec.bill_to_site_use_id := " . $bill_to_site_use_id . ";";
		}
		if ($tax_code != "") {
			$plsql .= " p_cust_site_use_rec.tax_code := '" . $tax_code . "';";
		}
		$plsql .= " p_cust_site_use_rec.primary_flag := '".$primary."';";
		$plsql .= " p_cust_site_use_rec.site_use_code := '" . $use . "';";
		$plsql .= " p_cust_site_use_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " hz_cust_account_site_v2pub.create_cust_site_use(";
		$plsql .= " 'T',";
		$plsql .= " p_cust_site_use_rec,";
		$plsql .= " p_customer_profile_rec,";
		$plsql .= " 'F',";
		$plsql .= " 'F',";
		$plsql .= " :x_site_use_id,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['x_site_use_id'] = 0;
		$len['x_site_use_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);
		return $var;
	}

	/**
	* __UpdateCustAcctSiteUse()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:51:12 PDT 2007
	*/
	private function __UpdateCustAcctSiteUse($cust_acct_site_use_id, $cust_acct_site_id, $location, $use, $tax_code="", $primary='N', $bill_to_site_id = 0, $object_version_number=1)
	{
		$plsql = "DECLARE ";
		$plsql .= " p_cust_site_use_rec HZ_CUST_ACCOUNT_SITE_V2PUB.CUST_SITE_USE_REC_TYPE;";
		$plsql .= " BEGIN ";
		$plsql .= " p_cust_site_use_rec.site_use_id := " . $cust_acct_site_use_id . ";";
		$plsql .= " p_cust_site_use_rec.cust_acct_site_id := " . $cust_acct_site_id . ";";
		$plsql .= " p_cust_site_use_rec.location := '" . strtoupper($location) . "';";
		if ($bill_to_site_use_id != 0) {
			$plsql .= " p_cust_site_use_rec.bill_to_site_use_id := " . $bill_to_site_use_id . ";";
		}
		if ($tax_code != "") {
			$plsql .= " p_cust_site_use_rec.tax_code := '" . $tax_code . "';";
		}
		$plsql .= " p_cust_site_use_rec.primary_flag := '" . $primary . "';";
		$plsql .= " p_cust_site_use_rec.site_use_code := '" . $use . "';";
		$plsql .= " p_cust_site_use_rec.status := 'A';";
		$plsql .= " hz_cust_account_site_v2pub.update_cust_site_use(";
		$plsql .= " 'T',";
		$plsql .= " p_cust_site_use_rec,";
		$plsql .= " :ver,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
		$plsql .= " IF :x_msg_count > 1 THEN ";
		$plsql .= "  FOR I IN 1..:x_msg_count ";
		$plsql .= "  LOOP ";
		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
		$plsql .= "  END LOOP;";
		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['ver'] = $object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);
		return $var;

	}
	/**
	* __CreateCustAcctSiteUseBillTo()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:01:08 PDT 2007
	*/
	protected function __CreateCustAcctSiteUseBillTo($cust_acct_site_id, $location, $tax_code="", $primary=0)
	{
		$var = $this->__CreateCustAcctSiteUse($cust_acct_site_id, $location, 'BILL_TO', $tax_code, ($primary?"Y":"N"));
		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateCustAcctSiteUseBillTo($cust_acct_site_id, $location, $tax_code, $primary) failed with error message " . $var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__CreateCustAcctSiteUseBillTo($cust_acct_site_id, $location, $tax_code, $primary) successful !", "data"=>array("site_use_id"=>$var["x_site_use_id"]));
	}

	/**
	* __UpdateCustAcctSiteUseBillTo()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:56:39 PDT 2007
	*/
	protected function __UpdateCustAcctSiteUseBillTo($cust_acct_site_use_id, $cust_acct_site_id, $location, $tax_code="", $primary=0, $object_version_number=1)
	{
	   $var = $this->__UpdateCustAcctSiteUse($cust_acct_site_use_id, $cust_acct_site_id, $location, 'BILL_TO', $tax_code, ($primary?"Y":"N"), 0, $object_version_number);
	   if ($var["x_return_status"] !== "S") {
	   	return array("error_code"=>-1, "error_message"=>"__UpdateCustAcctSiteUseBillTo($cust_acct_site_use_id, $cust_acct_site_id, $location, $tax_code, $primary, $object_version_number) failed with error message " . $var["x_msg_data"]);
	   }
	   return array("error_code"=>0, "error_message"=>"__UpdateCustAcctSiteUseBillTo($cust_acct_site_use_id, $cust_acct_site_id, $location, $tax_code, $primary, $object_version_number) successful !", "data"=>array());
	}

	/**
	* __CreateCustAcctSiteUseShipTo()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:01:08 PDT 2007
	*/
	protected function __CreateCustAcctSiteUseShipTo($cust_acct_site_id, $location, $tax_code="", $primary=0, $cust_acct_site_use_bill=0)
	{
		$var = $this->__CreateCustAcctSiteUse($cust_acct_site_id, $location, 'SHIP_TO', $tax_code, ($primary?"Y":"N"), $cust_acct_site_use_bill);
		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateCustAcctSiteUseShipTo($cust_acct_site_id, $location, $tax_code, $primary, $cust_acct_site_use_bill) failed with error message " . $var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__CreateCustAcctSiteUseShipTo($cust_acct_site_id, $location, $tax_code, $primary, $cust_acct_site_use_bill) successful !", "data"=>array("site_use_id"=>$var["x_site_use_id"]));
	}

	/**
	* __UpdateCustAcctSiteUseShipTo()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:56:39 PDT 2007
	*/
	protected function __UpdateCustAcctSiteUseShipTo($cust_acct_site_use_id, $cust_acct_site_id, $location, $tax_code="", $primary=0, $cust_acct_site_use_bill=0, $object_version_number=1)
	{
	   $var = $this->__UpdateCustAcctSiteUse($cust_acct_site_use_id, $cust_acct_site_id, $location, 'SHIP_TO', $tax_code, ($primary?"Y":"N"), $cust_acct_site_use_bill, $object_version_number);
	   if ($var["x_return_status"] !== "S") {
	   	return array("error_code"=>-1, "error_message"=>"__UpdateCustAcctSiteUseShipTo($cust_acct_site_use_id, $cust_acct_site_id, $location, $tax_code, $primary, $cust_acct_site_use_bill, $object_version_number) failed with error message " . $var["x_msg_data"]);
	   }
	   return array("error_code"=>0, "error_message"=>"__UpdateCustAcctSiteUseShipTo($cust_acct_site_use_id, $cust_acct_site_id, $location, $tax_code, $primary, $cust_acct_site_use_bill, $object_version_number) successful !", "data"=>array());
	}
	/**
	* __CreateCustAcctSiteUseDunning()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:01:08 PDT 2007
	*/
	protected function __CreateCustAcctSiteUseDunning($cust_acct_site_id, $location, $primary=0)
	{
		$var = $this->__CreateCustAcctSiteUse($cust_acct_site_id, $location, 'DUN', "", ($primary?"Y":"N"));
		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateCustAcctSiteUseDunning($cust_acct_site_id, $location, $primary) failed with error message " . $var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__CreateCustAcctSiteUseDunning($cust_acct_site_id, $location, $primary) successful !", "data"=>array("site_use_id"=>$var["x_site_use_id"]));
	}

	/**
	* __UpdateCustAcctSiteUseDunning()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:56:39 PDT 2007
	*/
	protected function __UpdateCustAcctSiteUseDunning($cust_acct_site_use_id, $cust_acct_site_id, $location, $primary=0, $object_version_number=1)
	{
	   $var = $this->__UpdateCustAcctSiteUse($cust_acct_site_use_id, $cust_acct_site_id, $location, 'DUN', "", ($primary?"Y":"N"), 0, $object_version_number);
	   if ($var["x_return_status"] !== "S") {
	   	return array("error_code"=>-1, "error_message"=>"__UpdateCustAcctSiteUseDunning($cust_acct_site_use_id, $cust_acct_site_id, $location, $primary, $object_version_number) failed with error message " . $var["x_msg_data"]);
	   }
	   return array("error_code"=>0, "error_message"=>"__UpdateCustAcctSiteUseDunning($cust_acct_site_use_id, $cust_acct_site_id, $location, $primary, $object_version_number) successful !", "data"=>array());
	}

	/**
	* __CreateCustAcctSiteUseShipTo()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:01:08 PDT 2007
	*/
	protected function __CreateCustAcctSiteUseStatements($cust_acct_site_id, $location, $primary=0)
	{
		$var = $this->__CreateCustAcctSiteUse($cust_acct_site_id, $location, 'STMTS', "", ($primary?"Y":"N"));
		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateCustAcctSiteUseStatements($cust_acct_site_id, $location, $primary) failed with error message " . $var["x_msg_data"]);
		}

		return array("error_code"=>0, "error_message"=>"__CreateCustAcctSiteUseStatements($cust_acct_site_id, $location, $primary) successful !", "data"=>array("site_use_id"=>$var["x_site_use_id"]));
	}

	/**
	* __UpdateCustAcctSiteUseStatements()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:56:39 PDT 2007
	*/
	protected function __UpdateCustAcctSiteUseStatements($cust_acct_site_use_id, $cust_acct_site_id, $location, $primary=0, $object_version_number=1)
	{
	   $var = $this->__UpdateCustAcctSiteUse($cust_acct_site_use_id, $cust_acct_site_id, $location, 'STMTS', "", ($primary?"Y":"N"), 0, $object_version_number);
	   if ($var["x_return_status"] !== "S") {
	   	return array("error_code"=>-1, "error_message"=>"__UpdateCustAcctSiteUseStatements($cust_acct_site_use_id, $cust_acct_site_id, $location, $primary, $object_version_number) failed with error message " . $var["x_msg_data"]);
	   }
	   return array("error_code"=>0, "error_message"=>"__UpdateCustAcctSiteUseStatements($cust_acct_site_use_id, $cust_acct_site_id, $location, $primary, $object_version_number) successful !", "data"=>array());
	}

	/**
	* CreateCustAccountSite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 16:36:02 PDT 2007
	*/
	public function CreateCustAccountSite($cust_account_id, $address1, $address2, $city, $county, $zip, $state, $country, $tax_code="", $primary=0) {

		$location = $this->__CreateLocation($address1, $address2, $city, $county, $zip, $state, $country);
		if ($location["error_code"]) {
			$this->rollback();
			return $location;
		}

		$party = $this->__GetCustAccountParty($cust_account_id);
		if ($party["error_code"]) {
			$this->rollback();
			return $party;
		}

		$party_site = $this->__CreatePartySite($party["data"]["PARTY_ID"], $location["data"]["location_id"], ($primary?"Y":"N"));
		if ($party_site["error_code"]) {
			$this->rollback();
			return $party_site;
		}

		$cust_acct_site = $this->__CreateCustAcctSite($cust_account_id, $party_site["data"]["party_site_id"]);
		if ($cust_acct_site["error_code"]) {
			$this->rollback();
			return $cust_acct_site;
		}

		$cust_acct_site_use_bill = $this->__CreateCustAcctSiteUseBillTo($cust_acct_site["data"]["cust_acct_site_id"], substr($address1, 0, 30), $tax_code, $primary);
		if ($cust_acct_site_use_bill["error_code"]) {
			$this->rollback();
			return $cust_acct_site_use_bill;
		}

		$cust_acct_site_use_ship = $this->__CreateCustAcctSiteUseShipTo($cust_acct_site["data"]["cust_acct_site_id"], substr($address1, 0, 30), $tax_code, $primary, $cust_acct_site_use_bill["data"]["site_use_id"]);
		if ($cust_acct_site_use_ship["error_code"]) {
			$this->rollback();
			return $cust_acct_site_use_ship;
		}

		if ($primary) {
			$cust_acct_site_use_dun = $this->__CreateCustAcctSiteUseDunning($cust_acct_site["data"]["cust_acct_site_id"], substr($address1, 0, 30), $primary);
			if ($cust_acct_site_use_dun["error_code"]) {
				$this->rollback();
				return $cust_acct_site_use_dun;
			}

			$cust_acct_site_use_stmts = $this->__CreateCustAcctSiteUseStatements($cust_acct_site["data"]["cust_acct_site_id"], substr($address1, 0, 30), $primary);
			if ($cust_acct_site_use_stmts["error_code"]) {
				$this->rollback();
				return $cust_acct_site_use_stmts;
			}
		}

		$this->commit();
		return array("error_code"=>0, "error_message"=>"CreateCustAccountSite($cust_account_id, $address1, $address2, $city, $county, $zip, $state, $country, $primary) successful!", "data"=>array("site_id"=>$cust_acct_site["data"]["cust_acct_site_id"]));
	}

	/**
	* __GetCustAccountSiteLocation()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:43:58 PDT 2007
	*/
	private function __GetCustAccountSiteLocation($cust_account_id, $cust_account_site_id)
	{
	   $q = "SELECT L.LOCATION_ID, L.OBJECT_VERSION_NUMBER, L.ADDRESS1, L.ADDRESS2, L.CITY, L.COUNTY, L.POSTAL_CODE, L.STATE, L.COUNTRY FROM HZ_CUST_ACCT_SITES CS LEFT JOIN HZ_PARTY_SITES PS ON PS.PARTY_SITE_ID = CS.PARTY_SITE_ID LEFT JOIN HZ_LOCATIONS L ON L.LOCATION_ID = PS.LOCATION_ID WHERE CS.CUST_ACCOUNT_ID = '" . $cust_account_id . "' AND CS.CUST_ACCT_SITE_ID = '" . $cust_account_site_id . "'";
	   $this->parse($q);
	   $this->execute(OCI_DEFAULT);

	   if ($tmp = $this->fetch_assoc()) {
	   	return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
	   }
	   return array("error_code"=>-1, "error_message"=>"__GetCustAccountSiteLocation($cust_account_id, $cust_account_site_id) didn't retrieve any results !");
	}

	/**
	* __GetCustAccountPartySite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 18:39:34 PDT 2007
	*/
	private function __GetCustAccountPartySite($cust_account_id, $cust_account_site_id)
	{
	   $q = "SELECT PS.PARTY_SITE_ID, PS.OBJECT_VERSION_NUMBER FROM HZ_CUST_ACCT_SITES CS LEFT JOIN HZ_PARTY_SITES PS ON PS.PARTY_SITE_ID = CS.PARTY_SITE_ID LEFT JOIN HZ_LOCATIONS L ON L.LOCATION_ID = PS.LOCATION_ID WHERE CS.CUST_ACCOUNT_ID = '" . $cust_account_id . "' AND CS.CUST_ACCT_SITE_ID = '" . $cust_account_site_id . "'";
	   $this->parse($q);
	   $this->execute(OCI_DEFAULT);

	   if ($tmp = $this->fetch_assoc()) {
	  		return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
	   }
	   return array("error_code"=>-1, "error_message"=>"__GetCustAccountPartySite($cust_account_id, $cust_account_site_id) didn't retrieve any result !");
	}

	/**
	* __GetCustAcctSiteUse()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 19:05:33 PDT 2007
	*/
	private function __GetCustAcctSiteUse($cust_account_id, $cust_account_site_id, $use)
	{
	   $q = "SELECT CSU.SITE_USE_ID, CSU.OBJECT_VERSION_NUMBER FROM HZ_CUST_ACCT_SITES CS LEFT JOIN HZ_CUST_SITE_USES CSU ON CSU.CUST_ACCT_SITE_ID=CS.CUST_ACCT_SITE_ID WHERE CS.CUST_ACCOUNT_ID='".$cust_account_id."' AND CS.CUST_ACCT_SITE_ID='".$cust_account_site_id."' AND CSU.SITE_USE_CODE='".$use."'";
	   $this->parse($q);
	   $this->execute(OCI_DEFAULT);

	   if ($tmp = $this->fetch_assoc()) {
	  		return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
	   }
	   return array("error_code"=>-1, "error_message"=>"__GetCustAcctSiteUse($cust_account_id, $cust_account_site_id, $use) didn't retrieve any result !");
	}

	/**
	* UpdateCustAccountSite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 17:34:41 PDT 2007
	*/
	public function UpdateCustAccountSite($cust_account_id, $cust_account_site_id, $address1, $address2, $city, $county, $zip, $state, $country, $tax_code="", $primary=0)
	{
		$location = $this->__GetCustAccountSiteLocation($cust_account_id, $cust_account_site_id);

		if ($location["error_code"]) {
			$this->rollback();
			return $location;
		}
		if (($location["data"]["ADDRESS1"] != strtoupper($address1)) ||
		    ($location["data"]["ADDRESS2"] != strtoupper($address2)) ||
		    ($location["data"]["CITY"] != strtoupper($city)) ||
		    ($location["data"]["POSTAL_CODE"] != strtoupper($zip)) ||
		    ($location["data"]["STATE"] != strtoupper($state)) ||
		    ($location["data"]["COUNTRY"] != strtoupper($country))) {

		   $tmp = $this->__UpdateLocation($location["data"]["LOCATION_ID"], $address1, $address2, $city, $county, $zip, $state, $country, $location["data"]["OBJECT_VERSION_NUMBER"]);
			if ($tmp["error_code"]) {
				$this->rollback();
				return $tmp;
			}
		}

		if ($primary) {
			$party_site = $this->__GetCustAccountPartySite($cust_account_id, $cust_account_site_id);
			if ($party_site["error_code"]) {
				$this->rollback();
				return $party_site;
			}

			$tmp = $this->__UpdatePartySite($party_site["data"]["PARTY_SITE_ID"], $location["data"]["LOCATION_ID"], "Y", $party_site["data"]["OBJECT_VERSION_NUMBER"]);
			if ($tmp["error_code"]) {
				$this->rollback();
				return $tmp;
			}
		}

//		if ($location["data"]["ADDRESS1"] != strtoupper($address1) || $location["data"]) {
			$site_use = $this->__GetCustAcctSiteUse($cust_account_id, $cust_account_site_id, "BILL_TO");
			if ($site_use["error_code"]) {
				$cust_acct_site_use_bill = $this->__CreateCustAcctSiteUseBillTo($cust_account_site_id, substr($address1, 0, 30), $tax_code, $primary);
			} else {
				$cust_acct_site_use_bill = $this->__UpdateCustAcctSiteUseBillTo($site_use["data"]["SITE_USE_ID"], $cust_account_site_id, substr($address1, 0, 30), $tax_code, $primary, $site_use["data"]["OBJECT_VERSION_NUMBER"]);
				$cust_acct_site_use_bill["data"]["site_use_id"] = $site_use["data"]["SITE_USE_ID"];
			}
			if ($cust_acct_site_use_bill["error_code"]) {
				$this->rollback();
				return $cust_acct_site_use_bill;
			}

			$site_use = $this->__GetCustAcctSiteUse($cust_account_id, $cust_account_site_id, "SHIP_TO");
			if ($site_use["error_code"]) {
				$cust_acct_site_use_ship = $this->__CreateCustAcctSiteUseShipTo($cust_account_site_id, substr($address1, 0, 30), $tax_code, $primary, $cust_acct_site_use_bill["data"]["site_use_id"]);
			} else {
				$cust_acct_site_use_ship = $this->__UpdateCustAcctSiteUseShipTo($site_use["data"]["SITE_USE_ID"], $cust_account_site_id, substr($address1, 0, 30), $tax_code, $primary, $cust_acct_site_use_bill["data"]["site_use_id"], $site_use["data"]["OBJECT_VERSION_NUMBER"]);
			}
			if ($cust_acct_site_use_ship["error_code"]) {
				$this->rollback();
				return $cust_acct_site_use_ship;
			}

			if ($primary) {
				$site_use = $this->__GetCustAcctSiteUse($cust_account_id, $cust_account_site_id, "DUN");
				if ($site_use["error_code"]) {
					$cust_acct_site_use_dun = $this->__CreateCustAcctSiteUseDunning($cust_account_site_id, substr($address1, 0, 30), $primary);
				} else {
					$cust_acct_site_use_dun = $this->__UpdateCustAcctSiteUseDunning($site_use["data"]["SITE_USE_ID"], $cust_account_site_id, substr($address1, 0, 30), $primary, $site_use["data"]["OBJECT_VERSION_NUMBER"]);
				}
				if ($cust_acct_site_use_dun["error_code"]) {
					$this->rollback();
					return $cust_acct_site_use_dun;
				}

				$site_use = $this->__GetCustAcctSiteUse($cust_account_id, $cust_account_site_id, "STMTS");
				if ($site_use["error_code"]) {
					$cust_acct_site_use_stmts = $this->__CreateCustAcctSiteUseStatements($cust_account_site_id, substr($address1, 0, 30), $primary);
				} else {
					$cust_acct_site_use_stmts = $this->__UpdateCustAcctSiteUseStatements($site_use["data"]["SITE_USE_ID"], $cust_account_site_id, substr($address1, 0, 30), $primary, $site_use["data"]["OBJECT_VERSION_NUMBER"]);
				}
				if ($cust_acct_site_use_stmts["error_code"]) {
					$this->rollback();
					return $cust_acct_site_use_stmts;
				}
			}
//		}

		$this->commit();
		return array("error_code"=>0, "error_message"=>"UpdateCustAccountSite($cust_account_id, $cust_account_site_id, $address1, $address2, $city, $county, $zip, $country, $primary) successful !", "data"=>array());
	}

	/**
	* GetCustAccountByName()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 22:47:35 PDT 2007
	*/
	public function GetCustAccountByName($company_name)
	{
		$q = "SELECT A.CUST_ACCOUNT_ID, P.PARTY_NAME, P.TAX_REFERENCE, P.JGZZ_FISCAL_CODE, CP.STANDARD_TERMS FROM HZ_CUST_ACCOUNTS A LEFT JOIN HZ_PARTIES P ON P.PARTY_ID=A.PARTY_ID LEFT JOIN HZ_CUSTOMER_PROFILES CP ON CP.CUST_ACCOUNT_ID=A.CUST_ACCOUNT_ID WHERE UPPER(P.PARTY_NAME)=UPPER('".$this->escape(trim($company_name))."') AND A.STATUS='A'";
		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_mesage"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"GetCustAccountByName($company_name) didn't retrieve any results !");
	}

	/**
	* GetCustAccountSite()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 23:07:33 PDT 2007
	*/
	public function GetCustAccountSite($cust_account_id, $cust_account_site_id)
	{
	   $q = "SELECT CS.CUST_ACCT_SITE_ID CUST_ACCOUNT_SITE_ID, CS.CUST_ACCOUNT_ID, L.ADDRESS1, L.CITY, L.POSTAL_CODE ZIP, L.COUNTRY, CSU.TAX_CODE ";
	   $q .= "FROM HZ_CUST_ACCT_SITES CS ";
	   $q .= "LEFT JOIN HZ_CUST_SITE_USES CSU ON CSU.CUST_ACCT_SITE_ID=CS.CUST_ACCT_SITE_ID AND CSU.SITE_USE_CODE='BILL_TO' AND CSU.STATUS='A' ";
	   $q .= "LEFT JOIN HZ_PARTY_SITES PS ON PS.PARTY_SITE_ID = CS.PARTY_SITE_ID ";
	   $q .= "LEFT JOIN HZ_LOCATIONS L ON L.LOCATION_ID = PS.LOCATION_ID ";
	   $q .= "WHERE CS.STATUS = 'A' AND CS.CUST_ACCOUNT_ID = '" . $cust_account_id ."' AND CS.CUST_ACCT_SITE_ID = '" . $cust_account_site_id . "'";

		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_mesage"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"GetCustAccountSite($cust_acct_site_id, $cust_account_id) didn't retrieve any results !");
	}

	/**
	* GetCustAccountSiteByAddress()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 23:01:29 PDT 2007
	*/
	public function GetCustAccountSiteByAddress($cust_account_id, $address1)
	{
		$q =
		"SELECT CS.CUST_ACCT_SITE_ID CUST_ACCOUNT_SITE_ID, CS.CUST_ACCOUNT_ID, L.ADDRESS1, L.CITY, L.POSTAL_CODE ZIP, L.COUNTRY, CSU.TAX_CODE
		 FROM HZ_CUST_ACCT_SITES CS
		 LEFT JOIN HZ_CUST_SITE_USES CSU ON CSU.CUST_ACCT_SITE_ID=CS.CUST_ACCT_SITE_ID AND CSU.SITE_USE_CODE='BILL_TO' AND CSU.STATUS='A'
		 LEFT JOIN HZ_PARTY_SITES PS ON PS.PARTY_SITE_ID = CS.PARTY_SITE_ID
		 LEFT JOIN HZ_LOCATIONS L ON L.LOCATION_ID = PS.LOCATION_ID
		 WHERE
		    UPPER(TRIM(L.ADDRESS1)) = UPPER('".$this->escape(trim($address1))."')
		    AND CS.CUST_ACCOUNT_ID = '$cust_account_id' AND CS.STATUS='A'";
		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_mesage"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"GetCustAccountSiteByAddress($cust_account_id, $address1) didn't retrieve any results !");
	}

	/**
	* GetCustAccountSiteContact()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 16:00:36 PDT 2007
	*/
	public function GetCustAccountSiteContact($cust_account_id, $cust_account_site_id, $contact_id)
	{
		$q = "SELECT C.CONTACT_ID, C.FIRST_NAME, C.LAST_NAME, CPE.EMAIL_ADDRESS EMAIL, CPP.PHONE_NUMBER PHONE, CPF.PHONE_NUMBER FAX
				FROM RA_CONTACTS C
				LEFT JOIN HZ_CUST_ACCOUNT_ROLES R ON R.CUST_ACCOUNT_ROLE_ID=C.CONTACT_ID
				LEFT JOIN HZ_CONTACT_POINTS CPE ON CPE.OWNER_TABLE_NAME='HZ_PARTIES' AND CPE.OWNER_TABLE_ID=R.PARTY_ID AND CPE.CONTACT_POINT_TYPE='EMAIL' AND CPE.STATUS='A'
				LEFT JOIN HZ_CONTACT_POINTS CPP ON CPP.OWNER_TABLE_NAME='HZ_PARTIES' AND CPP.OWNER_TABLE_ID=R.PARTY_ID AND CPP.CONTACT_POINT_TYPE='PHONE' AND CPP.PHONE_LINE_TYPE='GEN' AND CPP.STATUS='A'
				LEFT JOIN HZ_CONTACT_POINTS CPF ON CPF.OWNER_TABLE_NAME='HZ_PARTIES' AND CPF.OWNER_TABLE_ID=R.PARTY_ID AND CPF.CONTACT_POINT_TYPE='PHONE' AND CPF.PHONE_LINE_TYPE='FAX' AND CPF.STATUS='A'
				WHERE C.CONTACT_ID='".$contact_id."' AND C.CUSTOMER_ID='".$cust_account_id."' AND C.ADDRESS_ID='".$cust_account_site_id."' AND C.STATUS='A'";
		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"GetCustAccountSiteContact($cust_account_id, $cust_account_site_id, $contact_id) didn't retrieve any results !");
	}

	/**
	* GetCustAccountSiteContactByName()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Tue Jun 05 23:17:46 PDT 2007
	*/
	public function GetCustAccountSiteContactByNameEmail($cust_account_id, $cust_account_site_id, $first_name, $last_name, $email)
	{
		$q = "SELECT C.CONTACT_ID, C.FIRST_NAME, C.LAST_NAME, CPE.EMAIL_ADDRESS EMAIL, CPP.PHONE_NUMBER PHONE, CPF.PHONE_NUMBER FAX
				FROM RA_CONTACTS C
				LEFT JOIN HZ_CUST_ACCOUNT_ROLES R ON R.CUST_ACCOUNT_ROLE_ID=C.CONTACT_ID
				LEFT JOIN HZ_CONTACT_POINTS CPE ON CPE.OWNER_TABLE_NAME='HZ_PARTIES' AND CPE.OWNER_TABLE_ID=R.PARTY_ID AND CPE.CONTACT_POINT_TYPE='EMAIL' AND CPE.STATUS='A'
				LEFT JOIN HZ_CONTACT_POINTS CPP ON CPP.OWNER_TABLE_NAME='HZ_PARTIES' AND CPP.OWNER_TABLE_ID=R.PARTY_ID AND CPP.CONTACT_POINT_TYPE='PHONE' AND CPP.PHONE_LINE_TYPE='GEN' AND CPP.STATUS='A'
				LEFT JOIN HZ_CONTACT_POINTS CPF ON CPF.OWNER_TABLE_NAME='HZ_PARTIES' AND CPF.OWNER_TABLE_ID=R.PARTY_ID AND CPF.CONTACT_POINT_TYPE='PHONE' AND CPF.PHONE_LINE_TYPE='FAX' AND CPF.STATUS='A'
				WHERE UPPER(C.FIRST_NAME)=UPPER('".$this->escape(trim($first_name))."') AND UPPER(C.LAST_NAME)=UPPER('".$this->escape(trim($last_name))."') AND UPPER(CPE.EMAIL_ADDRESS)=UPPER('".$this->escape(trim($email))."') AND C.CUSTOMER_ID='".$cust_account_id."' AND C.ADDRESS_ID='".$cust_account_site_id."' AND C.STATUS='A'";
		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"GetCustAccountSiteContactByNameEmail($cust_account_id, $cust_account_site_id, $first_name, $last_name, $email) didn't retrieve any results !");
	}

	/**
	* __CreatePerson()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 15:00:42 PDT 2007
	*/
	protected function __CreatePerson($first_name, $last_name)
	{
		$plsql = "DECLARE ";
 		$plsql .= " p_create_person_rec HZ_PARTY_V2PUB.person_rec_type;";
 		$plsql .= " x_party_number VARCHAR2(2000);";
 		$plsql .= " x_profile_id NUMBER;";
		$plsql .= "BEGIN";
 		$plsql .= " p_create_person_rec.person_first_name := '".strtoupper($first_name)."';";
 		$plsql .= " p_create_person_rec.person_last_name := '".strtoupper($last_name)."';";
 		$plsql .= " p_create_person_rec.created_by_module := 'HUMMINGBIRD';";
 		$plsql .= " HZ_PARTY_V2PUB.create_person(";
 		$plsql .= " 'T',";
 		$plsql .= " p_create_person_rec	,";
 		$plsql .= " :x_party_id,";
 		$plsql .= " x_party_number,";
 		$plsql .= " x_profile_id,";
 		$plsql .= " :x_return_status,";
 		$plsql .= " :x_msg_count,";
 		$plsql .= " :x_msg_data);";
 		$plsql .= " IF :x_msg_count > 1 THEN ";
 		$plsql .= "  FOR I IN 1..:x_msg_count ";
 		$plsql .= "  LOOP ";
 		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
 		$plsql .= "  END LOOP;";
 		$plsql .= " END IF;";
		$plsql .= "END;";

 		$var['x_party_id'] = 0;
 		$len['x_party_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

 		$this->run($plsql, $var, $len, OCI_DEFAULT);
		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreatePerson($first_name, $last_name) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreatePerson($first_name, $last_name) successful !", "data"=>array("party_id"=>$var["x_party_id"]));
	}

	/**
	* __UpdatePerson()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 17:19:12 PDT 2007
	*/
	protected function __UpdatePerson($party_id, $first_name, $last_name, $object_version_number=1)
	{
		$plsql = "DECLARE ";
 		$plsql .= " p_person_rec HZ_PARTY_V2PUB.person_rec_type;";
 		$plsql .= " x_party_number VARCHAR2(2000);";
 		$plsql .= " x_party_id NUMBER;";
 		$plsql .= " x_profile_id NUMBER;";
		$plsql .= "BEGIN";
		$plsql .= " p_person_rec.party_rec.party_id := " . $party_id . ";";
		$plsql .= " p_person_rec.party_rec.status := 'A';";
 		$plsql .= " p_person_rec.person_first_name := '".strtoupper($first_name)."';";
 		$plsql .= " p_person_rec.person_last_name := '".strtoupper($last_name)."';";
 		$plsql .= " p_person_rec.created_by_module := 'HUMMINGBIRD';";
 		$plsql .= " HZ_PARTY_V2PUB.update_person(";
 		$plsql .= " 'T',";
 		$plsql .= " p_person_rec,";
 		$plsql .= " :ver,";
 		$plsql .= " x_profile_id,";
 		$plsql .= " :x_return_status,";
 		$plsql .= " :x_msg_count,";
 		$plsql .= " :x_msg_data);";
 		$plsql .= " IF :x_msg_count > 1 THEN ";
 		$plsql .= "  FOR I IN 1..:x_msg_count ";
 		$plsql .= "  LOOP ";
 		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
 		$plsql .= "  END LOOP;";
 		$plsql .= " END IF;";
		$plsql .= "END;";

 		$var['ver'] = $object_version_number;
 		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

 		$this->run($plsql, $var, $len, OCI_DEFAULT);
		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdatePerson($party_id, $first_name, $last_name) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__UpdatePerson($party_id, $first_name, $last_name) successful !", "data"=>array());

	}

	/**
	* __CreateOrgContact()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 15:06:30 PDT 2007
	*/
	protected function __CreateOrgContact($contact_party_id, $party_id)
	{
 		$plsql = "DECLARE ";
		$plsql .= " p_org_contact_rec HZ_PARTY_CONTACT_V2PUB.ORG_CONTACT_REC_TYPE;";
		$plsql .= " x_org_contact_id NUMBER;";
		$plsql .= " x_party_rel_id NUMBER;";
		$plsql .= " x_party_number VARCHAR2(2000);";
		$plsql .= "BEGIN";
		$plsql .= " p_org_contact_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " p_org_contact_rec.party_rel_rec.subject_id := " . $contact_party_id . ";";
		$plsql .= " p_org_contact_rec.party_rel_rec.subject_type := 'PERSON';";
		$plsql .= " p_org_contact_rec.party_rel_rec.subject_table_name := 'HZ_PARTIES';";
		$plsql .= " p_org_contact_rec.party_rel_rec.object_id := " . $party_id . ";";
		$plsql .= " p_org_contact_rec.party_rel_rec.object_type := 'ORGANIZATION';";
		$plsql .= " p_org_contact_rec.party_rel_rec.object_table_name := 'HZ_PARTIES';";
		$plsql .= " p_org_contact_rec.party_rel_rec.relationship_code := 'CONTACT_OF';";
		$plsql .= " p_org_contact_rec.party_rel_rec.relationship_type := 'CONTACT';";
		$plsql .= " hz_party_contact_v2pub.create_org_contact(";
		$plsql .= " 'T',";
		$plsql .= " p_org_contact_rec,";
		$plsql .= " x_org_contact_id,";
		$plsql .= " x_party_rel_id,";
		$plsql .= " :x_party_id,";
		$plsql .= " x_party_number,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
 		$plsql .= " IF :x_msg_count > 1 THEN ";
 		$plsql .= "  FOR I IN 1..:x_msg_count ";
 		$plsql .= "  LOOP ";
 		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
 		$plsql .= "  END LOOP;";
 		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['x_party_id'] = 0;
		$len['x_party_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateOrgContact($contact_party_id, $party_id) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreateOrgContact($contact_party_id, $party_id) successful !", "data"=>array("party_id"=>$var["x_party_id"]));
	}

	/**
	* __CreatePersonEmailContactPoint()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 15:13:27 PDT 2007
	*/
	protected function __CreateEmailContactPoint($org_contact_party_id, $email)
	{
		$plsql = "DECLARE "
		." p_contact_point_rec HZ_CONTACT_POINT_V2PUB.CONTACT_POINT_REC_TYPE;"
		." p_email_rec HZ_CONTACT_POINT_V2PUB.email_rec_type;"
		."BEGIN"
		." p_contact_point_rec.contact_point_type := 'EMAIL';"
		." p_contact_point_rec.owner_table_name := 'HZ_PARTIES';"
		." p_contact_point_rec.owner_table_id := " . $org_contact_party_id . ";"
		." p_contact_point_rec.created_by_module := 'HUMMINGBIRD';"
		." p_email_rec.email_address := '".strtoupper($email)."';"
		." HZ_CONTACT_POINT_V2PUB.create_email_contact_point ("
		." 'T',"
		." p_contact_point_rec,"
		." p_email_rec,"
		." :x_contact_point_id,"
		." :x_return_status,"
		." :x_msg_count,"
		." :x_msg_data);"
 		." IF :x_msg_count > 1 THEN "
 		."  FOR I IN 1..:x_msg_count "
 		."  LOOP "
 		."   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);"
 		."  END LOOP;"
 		." END IF;"
		."END;";

		$var['x_contact_point_id'] = 0;
		$len['x_contact_point_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateEmailContactPoint($org_contact_party_id, $email) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreateEmailContactPoint($org_contact_party_id, $email) successful !", "data"=>array("contact_point_id"=>$var["x_contact_point_id"]));
	}

	/**
	* __UpdateEmailContactPoint()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 17:40:43 PDT 2007
	*/
	protected function __UpdateEmailContactPoint($contact_point_id, $email, $object_version_number=1)
	{
		$plsql = "DECLARE "
		." p_contact_point_rec HZ_CONTACT_POINT_V2PUB.CONTACT_POINT_REC_TYPE;"
		." p_email_rec HZ_CONTACT_POINT_V2PUB.email_rec_type;"
		."BEGIN"
		." p_contact_point_rec.contact_point_type := 'EMAIL';"
		." p_contact_point_rec.contact_point_id := '".$contact_point_id."';"
		." p_contact_point_rec.status := 'A';"
		." p_email_rec.email_address := '".strtoupper($email)."';"
		." HZ_CONTACT_POINT_V2PUB.update_email_contact_point ("
		." 'T',"
		." p_contact_point_rec,"
		." p_email_rec,"
		." :ver,"
		." :x_return_status,"
		." :x_msg_count,"
		." :x_msg_data);"
 		." IF :x_msg_count > 1 THEN "
 		."  FOR I IN 1..:x_msg_count "
 		."  LOOP "
 		."   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);"
 		."  END LOOP;"
 		." END IF;"
		."END;";

		$var['ver'] = $object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdateEmailContactPoint($contact_point_id, $email, $object_version_number) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__UpdateEmailContactPoint($contact_point_id, $email, $object_version_number) successful !", "data"=>array());
	}

	/**
	* __CreatePersonPhoneContactPoint()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 15:18:00 PDT 2007
	*/
	protected function __CreatePhoneContactPoint($org_contact_party_id, $phone, $type="GEN")
	{
		$plsql = "DECLARE "
		." p_contact_point_rec HZ_CONTACT_POINT_V2PUB.CONTACT_POINT_REC_TYPE;"
		." p_phone_rec HZ_CONTACT_POINT_V2PUB.phone_rec_type;"
		."BEGIN"
		." p_contact_point_rec.contact_point_type := 'PHONE';"
		." p_contact_point_rec.owner_table_name := 'HZ_PARTIES';"
		." p_contact_point_rec.owner_table_id := " . $org_contact_party_id . ";"
		." p_contact_point_rec.created_by_module := 'HUMMINGBIRD';"
		." p_phone_rec.phone_number := '" . $phone . "';"
		." p_phone_rec.phone_line_type := '" . $type . "';"
		." HZ_CONTACT_POINT_V2PUB.create_phone_contact_point ("
		." 'T',"
		." p_contact_point_rec,"
		." p_phone_rec,"
		." :x_contact_point_id,"
		." :x_return_status,"
		." :x_msg_count,"
		." :x_msg_data);"
 		." IF :x_msg_count > 1 THEN "
 		."  FOR I IN 1..:x_msg_count "
 		."  LOOP "
 		."   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);"
 		."  END LOOP;"
 		." END IF;"
		."END;";

		$var['x_contact_point_id'] = 0;
		$len['x_contact_point_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreatePhoneContactPoint($org_contact_party_id, $phone) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreatePhoneContactPoint($org_contact_party_id, $phone) successful !", "data"=>array("contact_point_id"=>$var["x_contact_point_id"]));
	}

	/**
	* __UpdatePhoneContactPoint()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 17:48:41 PDT 2007
	*/
	protected function __UpdatePhoneContactPoint($contact_point_id, $phone, $object_version_number=1, $type="GEN")
	{
		$plsql = "DECLARE "
		." p_contact_point_rec HZ_CONTACT_POINT_V2PUB.CONTACT_POINT_REC_TYPE;"
		." p_phone_rec HZ_CONTACT_POINT_V2PUB.phone_rec_type;"
		."BEGIN"
		." p_contact_point_rec.contact_point_type := 'PHONE';"
		." p_contact_point_rec.contact_point_id := '".$contact_point_id."';"
		." p_contact_point_rec.status := 'A';"
		." p_phone_rec.phone_number := '" . $phone . "';"
		." p_phone_rec.phone_line_type := '" . $type . "';"
		." HZ_CONTACT_POINT_V2PUB.update_phone_contact_point ("
		." 'T',"
		." p_contact_point_rec,"
		." p_phone_rec,"
		." :ver,"
		." :x_return_status,"
		." :x_msg_count,"
		." :x_msg_data);"
 		." IF :x_msg_count > 1 THEN "
 		."  FOR I IN 1..:x_msg_count "
 		."  LOOP "
 		."   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);"
 		."  END LOOP;"
 		." END IF;"
		."END;";

		$var['ver'] = $object_version_number;
		$len['ver'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__UpdatePhoneContactPoint($contact_point_id, $phone, $object_version_number, $type) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__UpdatePhoneContactPoint($contact_point_id, $phone, $object_version_number, $type) successful !", "data"=>array());

	}
	/**
	* __CreateCustAccountRole()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 15:23:06 PDT 2007
	*/
	protected function __CreateCustAccountRole($cust_account_id, $cust_acct_site_id, $org_contact_party_id, $primary="N")
	{
		$plsql = "DECLARE ";
		$plsql .= " p_cr_cust_acc_role_rec HZ_CUST_ACCOUNT_ROLE_V2PUB.cust_account_role_rec_type;";
		$plsql .= "BEGIN";
		$plsql .= " p_cr_cust_acc_role_rec.party_id := " . $org_contact_party_id . ";";
		$plsql .= " p_cr_cust_acc_role_rec.cust_account_id := " . $cust_account_id . ";";
		$plsql .= " p_cr_cust_acc_role_rec.cust_acct_site_id := " . $cust_acct_site_id . ";";
		$plsql .= " p_cr_cust_acc_role_rec.primary_flag := '" . $primary . "';";
		$plsql .= " p_cr_cust_acc_role_rec.role_type := 'CONTACT';";
		$plsql .= " p_cr_cust_acc_role_rec.created_by_module := 'HUMMINGBIRD';";
		$plsql .= " HZ_CUST_ACCOUNT_ROLE_V2PUB.create_cust_account_role(";
		$plsql .= " 'T',";
		$plsql .= " p_cr_cust_acc_role_rec,";
		$plsql .= " :x_cust_account_role_id,";
		$plsql .= " :x_return_status,";
		$plsql .= " :x_msg_count,";
		$plsql .= " :x_msg_data);";
 		$plsql .= " IF :x_msg_count > 1 THEN ";
 		$plsql .= "  FOR I IN 1..:x_msg_count ";
 		$plsql .= "  LOOP ";
 		$plsql .= "   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);";
 		$plsql .= "  END LOOP;";
 		$plsql .= " END IF;";
		$plsql .= "END;";

		$var['x_cust_account_role_id'] = 0;
		$len['x_cust_account_role_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			array("error_code"=>-1, "error_message"=>"__CreateCustAccountRole($cust_account_id, $cust_acct_site_id, $org_contact_party_id, $primary) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreateCustAccountRole($cust_account_id, $cust_acct_site_id, $org_contact_party_id, $primary) successful !", "data"=>array("role_id"=>$var["x_cust_account_role_id"]));
	}

	/**
	* __CreateRoleResponsibility()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 15:30:27 PDT 2007
	*/
	protected function __CreateRoleResponsibility($cust_account_role_id, $type="BILL_TO")
	{
		$plsql = "DECLARE "
		." p_role_responsibility_rec HZ_CUST_ACCOUNT_ROLE_V2PUB.ROLE_RESPONSIBILITY_REC_TYPE;"
		."BEGIN"
		." p_role_responsibility_rec.cust_account_role_id := " . $cust_account_role_id . ";"
		." p_role_responsibility_rec.responsibility_type := '" . $type . "';"
		." p_role_responsibility_rec.created_by_module := 'HUMMINGBIRD';"
		." HZ_CUST_ACCOUNT_ROLE_V2PUB.create_role_responsibility ("
		." 'T',"
		." p_role_responsibility_rec,"
		." :x_responsibility_id,"
		." :x_return_status,"
		." :x_msg_count,"
		." :x_msg_data);"
		." IF :x_msg_count > 1 THEN "
 		."  FOR I IN 1..:x_msg_count "
 		."  LOOP "
 		."   :x_msg_data := :x_msg_data||'\n'||SubStr(FND_MSG_PUB.Get(p_encoded => FND_API.G_FALSE), 1, 255);"
 		."  END LOOP;"
 		." END IF;"
		."END;";

		$var['x_responsibility_id'] = 0;
		$len['x_responsibility_id'] = 11;
		$var['x_return_status'] = "";
		$len['x_return_status'] = 2000;
		$var['x_msg_count'] = 0;
		$len['x_msg_count'] = 11;
		$var['x_msg_data'] = "";
		$len['x_msg_data'] = 2000;

		$this->run($plsql, $var, $len, OCI_DEFAULT);

		if ($var['x_return_status'] !== 'S') {
			return array("error_code"=>-1, "error_message"=>"__CreateRoleResponsibility($cust_account_role_id, $type) failed with message " . $var["x_msg_data"]);
		}
		return array("error_code"=>0, "error_message"=>"__CreateRoleResponsibility($cust_account_role_id, $type) successful !", "data"=>array("responsibility_id"=>$var["x_responsibility_id"]));
	}

	/**
	* CreateCustAccountSiteContact()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 10:41:23 PDT 2007
	*/
	public function CreateCustAccountSiteContact($cust_account_id, $cust_account_site_id, $first_name, $last_name, $email, $phone="", $fax="")
	{
		$check = $this->GetCustAccountSite($cust_account_id, $cust_account_site_id);
		if ($check["error_code"]) {
			$this->rollback();
			return $check;
		}

		$person = $this->__CreatePerson($first_name, $last_name);
		if ($person["error_code"]) {
			$this->rollback();
			return $person;
		}

		$party = $this->__GetCustAccountParty($cust_account_id);
		if ($party["error_code"]) {
			$this->rollback();
			return $party;
		}

		$org_contact = $this->__CreateOrgContact($person["data"]["party_id"], $party["data"]["PARTY_ID"]);
		if ($org_contact["error_code"]) {
			$this->rollback();
		}

		$email_point = $this->__CreateEmailContactPoint($org_contact["data"]["party_id"], $email);
		if ($email_point["error_code"]) {
			$this->rollback();
			return $email_point;
		}

		if ($phone != "") {
			$phone_point = $this->__CreatePhoneContactPoint($org_contact["data"]["party_id"], $phone);
			if ($phone_point["error_code"]) {
				$this->rollback();
				return $phone_point;
			}
		}

		if ($fax != "") {
			$fax_point = $this->__CreatePhoneContactPoint($org_contact["data"]["party_id"], $fax, "FAX");
			if ($fax_point["error_code"]) {
				$this->rollback();
				return $fax_point;
			}
		}

		$cust_account_role = $this->__CreateCustAccountRole($cust_account_id, $cust_account_site_id, $org_contact["data"]["party_id"]);
		if ($cust_account_role["error_code"]) {
			$this->rollback();
			return $cust_account_role;
		}

		$role_reponsibility = $this->__CreateRoleResponsibility($cust_account_role["data"]["role_id"]);
		if ($role_reponsibility["error_code"]) {
			$this->rollback();
			return $role_reponsibility;
		}

		$this->commit();
		return array("error_code"=>0, "error_message"=>"CreateCustAccountSiteContact($cust_account_id, $cust_account_site_id, $first_name, $last_name, $email, $phone, $fax) successful !", "data"=>array("contact_id"=>$cust_account_role["data"]["role_id"]));
	}

	/**
	* __GetPerson()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 17:29:28 PDT 2007
	*/
	private function __GetPerson($cust_account_id, $cust_acct_site_id, $contact_id)
	{
		$q = "SELECT P.PARTY_ID, P.OBJECT_VERSION_NUMBER, C.FIRST_NAME, C.LAST_NAME, R.PARTY_ID ORG_CONTACT_PARTY_ID,
				CPE.EMAIL_ADDRESS EMAIL, CPE.CONTACT_POINT_ID EMAIL_CONTACT_POINT_ID, CPE.OBJECT_VERSION_NUMBER EMAIL_OBJECT_VERSION_NUMBER,
				CPP.PHONE_NUMBER PHONE, CPP.CONTACT_POINT_ID PHONE_CONTACT_POINT_ID, CPP.OBJECT_VERSION_NUMBER PHONE_OBJECT_VERSION_NUMBER,
				CPF.PHONE_NUMBER FAX, CPF.CONTACT_POINT_ID FAX_CONTACT_POINT_ID, CPF.OBJECT_VERSION_NUMBER FAX_OBJECT_VERSION_NUMBER
				FROM RA_CONTACTS C
				LEFT JOIN HZ_CUST_ACCOUNT_ROLES R ON R.CUST_ACCOUNT_ROLE_ID=C.CONTACT_ID
				LEFT JOIN HZ_PARTIES P ON P.PARTY_ID=C.CONTACT_PARTY_ID
				LEFT JOIN HZ_CONTACT_POINTS CPE ON CPE.OWNER_TABLE_NAME='HZ_PARTIES' AND CPE.OWNER_TABLE_ID=R.PARTY_ID AND CPE.CONTACT_POINT_TYPE='EMAIL' AND CPE.STATUS='A'
				LEFT JOIN HZ_CONTACT_POINTS CPP ON CPP.OWNER_TABLE_NAME='HZ_PARTIES' AND CPP.OWNER_TABLE_ID=R.PARTY_ID AND CPP.CONTACT_POINT_TYPE='PHONE' AND CPP.PHONE_LINE_TYPE='GEN' AND CPP.STATUS='A'
				LEFT JOIN HZ_CONTACT_POINTS CPF ON CPF.OWNER_TABLE_NAME='HZ_PARTIES' AND CPF.OWNER_TABLE_ID=R.PARTY_ID AND CPF.CONTACT_POINT_TYPE='PHONE' AND CPF.PHONE_LINE_TYPE='FAX' AND CPF.STATUS='A'
				WHERE C.CONTACT_ID='".$contact_id."' AND C.CUSTOMER_ID='".$cust_account_id."' AND C.ADDRESS_ID='".$cust_acct_site_id."'";
		$this->parse($q);
		$this->execute();

		if ($tmp = $this->fetch_assoc()) {
			return array("error_code"=>0, "error_message"=>"success", "data"=>$tmp);
		}
		return array("error_code"=>-1, "error_message"=>"__GetPerson($cust_account_id, $cust_acct_site_id, $contact_id) didn't retrieve any results !");
	}

	/**
	* UpdateCustAccountSiteContact()
	*
	* @param
	* @todo NOT YET COMPLETED
	* @return
	* @since  - 2.0.2 - Wed Jun 06 17:05:36 PDT 2007
	*/
	public function UpdateCustAccountSiteContact($cust_account_id, $cust_account_site_id, $contact_id, $first_name, $last_name, $email, $phone="", $fax="")
	{
	   $person = $this->__GetPerson($cust_account_id, $cust_account_site_id, $contact_id);
	   if (($person["data"]["FIRST_NAME"] != strtoupper($first_name)) ||
	   	 ($person["data"]["LAST_NAME"] != strtoupper($last_name))) {
	   	$tmp = $this->__UpdatePerson($person["data"]["PARTY_ID"], $first_name, $last_name, $person["data"]["OBJECT_VERSION_NUMBER"]);
	   	if ($tmp["error_code"]) {
	   		$this->rollback();
	   		return $tmp;
	   	}
	  	}

	  	if ($person["data"]["EMAIL"] != strtoupper($email)) {
	  		$tmp = $this->__UpdateEmailContactPoint($person["data"]["EMAIL_CONTACT_POINT_ID"], $email, $person["data"]["EMAIL_OBJECT_VERSION_NUMBER"]);
	  		if ($tmp["error_code"]) {
	  			$this->rollback();
	  			return $tmp;
	  		}
	  	}

	  	if ($person["data"]["PHONE"] != strtoupper($phone)) {
	  		if ($person["data"]["PHONE"] == "") {
	  			$tmp = $this->__CreatePhoneContactPoint($person["data"]["ORG_CONTACT_PARTY_ID"], $phone);
	  		} else {
	  			$tmp = $this->__UpdatePhoneContactPoint($person["data"]["PHONE_CONTACT_POINT_ID"], $phone, $person["data"]["PHONE_OBJECT_VERSION_NUMBER"]);
	  		}
	  		if ($tmp["error_code"]) {
	  			$this->rollback();
	  			return $tmp;
	  		}
	  	}

	  	if ($person["data"]["FAX"] != strtoupper($fax)) {
	  		if ($person["data"]["FAX"] == "") { echo "Create Fax !!!\n";
	  			$tmp = $this->__CreatePhoneContactPoint($person["data"]["ORG_CONTACT_PARTY_ID"], $fax, "FAX");
	  		} else {
	  			$tmp = $this->__UpdatePhoneContactPoint($person["data"]["FAX_CONTACT_POINT_ID"], $fax, $person["data"]["FAX_OBJECT_VERSION_NUMBER"], "FAX");
	  		}
	  		if ($tmp["error_code"]) {
	  			$this->rollback();
	  			return $tmp;
	  		}
	  	}

		$this->commit();
		return array("error_code"=>0, "error_message"=>"UpdateCustAccountSiteContact($cust_account_id, $cust_account_site_id, $contact_id, $first_name, $last_name, $email, $phone, $fax) successful !", "data"=>array());
	}
}
?>
