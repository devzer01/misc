<?php
/**
 * Class for US Address Validation
 * 
 * @copyright 2007 Global Market Insite Inc
 * @author ddayananda
 * @version 1.0
 * @package Util
 * @subpackage Service
 */ 

class Hb_Util_Service_AddressValidation_UPSAddressValidator implements Hb_Util_Service_AddressValidation_AddressValidationInterface
{
	/**
	 * Input Address
	 *
	 * @var Hb_App_Common_Address
	 */
	protected $address = null ;
	
	/**
	 * Response generated by UPS
	 *
	 * @var Hb_Util_Service_AddressValidation_UPS_UPSAddress
	 */
	protected $response = null ;
	
	
	/**
	 * Sets the address
	 *
	 * @param Hb_App_Common_Address $address Address
	 */
	function SetAddress($address)
	{
		$this->address = $address ;		
	}
	
	/**
	 * Checks whether the address is valid
	 *
	 * @return boolean
	 */
	public function IsValid()
	{
		$this->response = $this->doValidationRequest();		
		 
		if ( 1 == $this->response->GetStatusCode())
		{
			return true ;
		}
		else
		{
			return false ;
		}
	}

	/**
	 * Return array of recommended address
	 *
	 * @return array
	 */
	public function GetRecommendedAddresses()
	{
		if ( is_null($this->response) ) return array();
		
		if ( 2 == $this->response->GetStatusCode())
		{		
			$recommended_addresses = array() ;
			foreach ($this->response->GetRecommendedAddresses() as $result) 
			{
				$obj = new Hb_App_Common_Address(null,$result->Address->City,$this->address->GetAddressCountryCode(),null,$result->Address->StateProvinceCode,$this->address->GetAddressStreet1(),$this->address->GetAddressStreet2(),null,$result->PostalCodeLowEnd,null);
				array_push($recommended_addresses,$obj) ;	
			}
			return $recommended_addresses ;
		}
		else 
		{
			return array() ;
		}
	
	}
	/**
	 * Return Status Code
	 *
	 * @return int
	 */
	public  function GetStatusCode()
	{
		return $this->response->GetStatusCode() ;	
	}
	
	/**
	 * Return Status Description
	 *
	 * @return string
	 */
	public  function GetStatusDescription()
	{
		return $this->response->GetStatusDescription()	;
	}
	
	protected function doValidationRequest()
	{ 
		$sys_config = Hb_Util_Config_SystemConfigReader::Read('service');
		
		$ups = new Hb_Util_Service_AddressValidation_UPS_UPSAddress($sys_config->ups->key, $sys_config->ups->username,$sys_config->ups->password, $sys_config->ups->timeout);
		$ups->SetCity($this->address->GetAddressCity());
		$ups->SetState($this->address->GetAddressState());
		$ups->SetZip($this->address->GetAddressZip());	

		
		return  $ups->GetResponse();
	}
}
?>
